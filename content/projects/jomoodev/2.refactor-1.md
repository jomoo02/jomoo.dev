---
title: jomoo.dev 리팩터링-1 
description: 블로그 리팩터링 하기 첫 번째, pinia store
date: 2023/12/25
---

# jomoo.dev 리팩터링-1
<div class="flex justify-end text-sm">2023/12/25</div>

### intro
이전 단어장 프로젝트의 리팩터링을 마무리하고, 리팩터링에 재미가 붙어, jomoo.dev 프로젝트의 코드도 리팩터링하려 한다. 이전에 기능 구현만을 우선했기에 훑어만 봐도 리팩터링할게 많아 보인다.  
일단 pinia store의 코드부터 리팩터링하겠다.  

### 이전 pinia store 구조
<img width="209" alt="스크린샷 2023-12-25 오후 3 13 06" src="https://github.com/jomoo02/jomoo.dev/assets/86420174/019bd152-1600-4965-955d-cbe0f15b0e2d">

어떤 레이아웃을 띄울지 정하는 상태와, 모달 상태를 다루는 `mainState.js`와 작성한 포스트들의 상태를 관리하는 `postData.js` 두 개의 저장소가 있다. 저장소의 구조와 네이밍 등을 변경하려 한다.

#### `mainState.js`

```js
import { defineStore } from 'pinia';

export const useMainStateStore = defineStore('mainState', {
  state: () => ({
    defaultLayoutIdx: 0,
    modalCheck: false,
  }),
});

```

리팩터링 전 `mainState` 저장소
우선 해당 프로젝트에 pinia store는 option store의 형태다. pinia를 몇 번 사용하다보니, option store 보다는 setup store 형태가 더 사용하기 편했다. vue의 composition api와 script setup 방식과 유사해 이질감이 적다.  
따라서 pinia store의 문법을 setup store로 변경하겠다.

또한, 현재 해당 스토어에서는 상태만을 저장하고, 해당 상태를 외부에서 다루게 한다.  
외부에서는 상태를 함수 호출을 통해 간접적으로 변경시키고, 내부에서 직접 상태를 변경하는게 상태에 대한 책임에 집중해 예측 가능성 및 유지 보수성도 향상된다고 생각한다. 따라서 상태를 조작를 스토어에서 하도록 변경하려한다.  

마지막으로, 레이아웃을 정하는 상태와 modal 상태는 서로 다른 기능이기 때문에 기능에 따라 스토어를 분리하는 게 적합하다고 생각한다. 레이아웃에 관련된 스토어 `layoutStore`와 modal과 관련된 스토어 `modalStore`로 분리하겠다. 

#### `default.vue`

```vue
<template>
  <div class="max-h-full">
    <div class="fixed top-0 z-20 w-full bg-white">
      <header class="border-b-[1px] border-b-gray-300">
        <div class="mx-auto max-w-7xl px-6 sm:px-4 lg:px-8 relative w-full">
          <nav
            class="grid grid-cols-6 min-h-16 max-h-20 items-center h-16 lg:h-20 justify-center"
          >
            <div
              class="col-span-1 flex justify-start cursor-pointer md:hidden"
              @click="hiddenMenuOperation"
            >
              <ListIcon />
            </div>
            <div
              class="flex justify-center md:justify-start col-span-4 md:col-span-1"
            >
              <div class="text-2xl font-extrabold text-stone-800">
                <NuxtLink to="/" @click="home()">JOMOO.DEV</NuxtLink>
              </div>
            </div>
            <ul
              class="hidden md:flex justify-center gap-x-10 col-span-4 font-semibold"
            >
              <li>
                <NuxtLink to="/note/programmers">
                  <div
                    class="flex p-1.5 text-zinc-600 border-b-[2px] border-b-white hover:text-emerald-500"
                    :class="mainStore.defaultLayoutIdx === 1 ? 'link' : ''"
                    @click="menuSelectNote()"
                  >
                    Note
                  </div>
                </NuxtLink>
              </li>
              <li>
                <NuxtLink to="/projects/vocabularynote">
                  <div
                    class="flex p-1.5 text-zinc-600 border-b-[2px] border-b-white hover:text-emerald-500"
                    :class="mainStore.defaultLayoutIdx === 2 ? 'link' : ''"
                    @click="menuSelectProjects()"
                  >
                    Projects
                  </div>
                </NuxtLink>
              </li>
              <li>
                <div class="p-1.5 cursor-not-allowed text-zinc-600">etc</div>
              </li>
            </ul>
          </nav>
        </div>
      </header>
    </div>
    <div class="mt-16 pt-2.5 md:mt-32">
      <slot />
    </div>
    <Teleport to="body">
      <div
        v-if="mainStore.modalCheck === true"
        class="fixed inset-0 z-[999] mt-16 w-full bg-white"
      >
        <div class="flex pt-2.5">
          <ul
            class="flex-col px-4 justify-center gap-x-10 col-span-4 font-semibold"
          >
            <li>
              <NuxtLink to="/note/programmers">
                <div
                  class="flex p-1.5 text-zinc-600 hover:text-emerald-500"
                  :class="mainStore.defaultLayoutIdx === 1 ? 'link_md' : ''"
                  @click="menuSelectNote()"
                >
                  Note
                </div>
              </NuxtLink>
            </li>
            <li>
              <NuxtLink to="/projects/vocabularynote">
                <div
                  class="flex p-1.5 text-zinc-600 hover:text-emerald-500"
                  :class="mainStore.defaultLayoutIdx === 2 ? 'link_md' : ''"
                  @click="menuSelectProjects()"
                >
                  Projects
                </div>
              </NuxtLink>
            </li>
            <li class="p-1.5 cursor-not-allowed text-zinc-600">etc</li>
          </ul>
        </div>
      </div>
    </Teleport>
  </div>
</template>

<script setup>
import { useMainStateStore } from '~~/store/mainState';

const mainStore = useMainStateStore();
const route = useRoute();
const routes = route.path.split('/');

if (routes[1] === 'note') {
  mainStore.defaultLayoutIdx = 1;
} else if (routes[1] === 'projects') {
  mainStore.defaultLayoutIdx = 2;
}

function overflowYRemove() {
  mainStore.modalCheck = false;
  if (process.client) {
    document.body.classList.remove('overflow-y-hidden');
  }
}

function home() {
  mainStore.defaultLayoutIdx = 0;
  overflowYRemove();
}

function menuSelectNote() {
  mainStore.defaultLayoutIdx = 1;
  overflowYRemove();
}

function menuSelectProjects() {
  mainStore.defaultLayoutIdx = 2;
  overflowYRemove();
}

function hiddenMenuOperation() {
  if (mainStore.modalCheck === true) {
    overflowYRemove();
  } else {
    mainStore.modalCheck = true;
    if (process.client) {
      document.body.classList.add('overflow-y-hidden');
    }
  }
}
</script>
<style scoped>
.link {
  border-bottom-width: 2px;
  --tw-border-opacity: 1;
  border-bottom-color: rgb(5 150 105 / var(--tw-border-opacity));
  color: #047857;
}
.link_md {
  color: #047857;
}
</style>

```

리팩터링 전 기본 레이아웃 컴포넌트, 해당 컴포넌트에서 `mainState` 스토어의 상태를 주로 이용한다. 따라서 스토어를 리팩터링하기 전 해당 레이아웃 컴포넌트를 먼저 리팩터링하려한다.  

일단 화면 넓이가 768px보다 작을 때, Teleport를 이용해 레이아웃을 모달 형식으로 렌더링하는 코드는 분리할 수 있을 거 같다. 또 composables 함수로 분리할 수 있는 기능들은 분리를 시도해보려한다.

### 리팩터링 후

#### `constants/categories.js`
```js
const HOME = 'home';
const NOTE = 'note';
const PROJECTS = 'projects';

export { HOME, NOTE, PROJECTS };

```

#### `categoriesStore.js`
```js
import { defineStore } from 'pinia';
import { HOME, NOTE, PROJECTS } from '../constants/categories';

export const useCategoriesStore = defineStore('categories', () => {
  const categoriesState = ref(HOME);

  function selectHome() {
    categoriesState.value = HOME;
  }

  function selectNote() {
    categoriesState.value = NOTE;
  }

  function selectS() {
    categoriesState.value = PROJECTS;
  }

  return {
    categoriesState,
    selectHome,
    selectNote,
    selectProject,
  };
});


```

레이아웃 상태를 categories라 명명하고, 카테고리를 갖는 상수 파일을 만들었다. 해당 스토어에서만 직접적으로 현재 선택한 카테고리를 변경하여, 책임성과 유지보수성을 향상시켰다.

#### `middleware/categories.global.js`
```js
import { useCategoriesStore } from '~~/store/categoriesStore';
import { NOTE, PROJECTS } from '../constants/categories';

export default defineNuxtRouteMiddleware((to, from) => {
  if (from.path === to.path) return;

  const categoriesStore = useCategoriesStore();
  const { selectHome, selectNote, selectProject } = categoriesStore;
  const toPath = to.path.split('/')[1];

  if (toPath === '') {
    selectHome();
  } else if (toPath === NOTE) {
    selectNote();
  } else if (toPath === PROJECTS) {
    selectProject();
  }
});

```

새롭게 추가된 디렉터리와 파일  
현재, 선택한 카테고리에 따라 css 스타일을 추가해 어떤 카테고리를 선택했는지 보여주고 있다. 이 기능을 watchEffect, composables 등 다양한 방식으로 구현했지만 middleware를 이용한 방식이 제일 깔끔한 방식인 거 같아 변경했다.   
middleware 디렉터리는 nuxt가 특정 경로로 이동하기 전에 코드를 실행하기 위해 제공한다. 어떤 경로인지에 따라 카테고리 상태를 변경하고 싶기에 적합한 기능이라 생각해 이용했다. 자세한 내용은 공식 홈페이지 링크를 남기겠다.

> <a href="https://nuxt.com/docs/guide/directory-structure/middleware" target="_blank" class="font-bold">nuxt3 공식 홈페이지 middleware</a>  

이 미들웨어를 통해 애플리케이션 경로를 이동하기 전에 경로를 검사해 스토어의 카테고리 상태 변경 함수를 호출한다. 만약 이전 경로와 이동할 경로가 같다면 return해 불필요한 로직을 실행하지 않는다.