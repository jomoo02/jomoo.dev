---
title: 리팩터링-3
description: 단어장 리팩터링, mainStore 분리
date: 2023/12/15
---

# 단어장 리팩터링 - 3
<div class="flex justify-end text-sm">2023/12/15</div>

### intro
현재 Main.js에 로컬 스토리지의 저장된 단어들의 상태와 그 단어들을 다루는 모든 기능들이 몰려 있어 가독성이 떨어진다. 스토어의 코드들을 상태와 기능에 따라 분리하는게 이번 리팩터링 목표다.

#### 리팩터링 전 mainStore 코드
```js
import { ref } from 'vue';
import { defineStore } from 'pinia';
import { useStorage } from '@vueuse/core';
export const useMainStore = defineStore('main', () => {
  // 휴지통, 메인화면 전환 0: 메인, 1: 휴지통
  const screenTransition = ref(0);

  const localWords = useStorage('mapWords', new Map(), localStorage);
  const localTrashCan = useStorage('trashCan', new Map(), localStorage);
  const localRecentSearchWords = useStorage('recentWords', [], localStorage);

  const wordArr = ref([]);

  function getTimeAndTimestamp() {
    const date = new Date();
    const nowTime = `${date.getFullYear()}-${
      date.getMonth() + 1
    }-${date.getDate()} ${date.getHours()}:${date.getMinutes()}`;
    const timestamp = date.getTime();
    return { date, nowTime, timestamp };
  }
  function getTimeAndTimestampAfterDay(day) {
    const { date, nowTime, timestamp } = getTimeAndTimestamp();
    const afterDate = new Date(date.setDate(date.getDate() + day));
    const afterTimestamp = afterDate.getTime();
    const afterTime = `${afterDate.getFullYear()}-${
      afterDate.getMonth() + 1
    }-${afterDate.getDate()} ${afterDate.getHours()}:${afterDate.getMinutes()}`;
    return { nowTime, timestamp, afterTime, afterTimestamp };
  }
  function wordArrUpdate() {
    const localWordsToArr = Array.from(localWords.value, (item) => {
      return { ...item[1] };
    });
    wordArr.value = [...localWordsToArr].reverse();
  }
  // init: localStorage에 있는 단어들 set
  function setWordDic() {
    wordArrUpdate();
    // 휴지통 갱신
    const { timestamp } = getTimeAndTimestamp();
    for (const [key, value] of localTrashCan.value) {
      if (value.afterTimestamp <= timestamp) {
        localTrashCan.value.delete(key);
      }
    }
  }
  // word add
  function wordAdd(word, means) {
    const { nowTime, timestamp } = getTimeAndTimestamp();
    const item = {
      word,
      timestamp,
      means: means.toString(),
      time: nowTime,
      check: false,
    };
    // 이미 단어가 존재하면 지웠다가 저장
    if (localWords.value.has(word)) {
      localWords.value.delete(word);
    }
    localWords.value.set(word, item);
    wordArrUpdate();
  }
  // word check
  function wordCheck(targetWord, ch, index) {
    wordArr.value[index].check = ch;
    const checkedWord = localWords.value.get(targetWord);
    checkedWord.check = ch;
    localWords.value.set(targetWord, checkedWord);
  }

  // word delete
  function wordDelete(targetWord) {
    const { nowTime, timestamp, afterTime, afterTimestamp} = getTimeAndTimestampAfterDay(14);
    const deleteWord = {
      timestamp,
      afterTimestamp,
	@@ -120,57 +120,29 @@
    const { word, means, afterTime, time } =
      localTrashCan.value.get(targetWord);
    const detailTrashCanWord = {
      means: means.split(','),
      word,
      time,
      afterTime,
    };
    return detailTrashCanWord;
  }
  // trashCan word kill
  function trashCanWordKill(targetWord) {
    localTrashCan.value.delete(targetWord);
  }
  // trashCan word restore
  function trashCanWordRestore(targetWord) {
    const { word, means } = localTrashCan.value.get(targetWord);
    wordAdd(word, means);
    trashCanWordKill(word);
  }

  // recent words update
  function recentWordUpdate(searchWord) {
    // 중복 확인
    const repeatCheckIndex = localRecentSearchWords.value.findIndex(
      (word) => word === searchWord,
    );
    const recentWords =
      repeatCheckIndex !== -1
        ? [
            ...localRecentSearchWords.value.slice(0, repeatCheckIndex),
            ...localRecentSearchWords.value.slice(repeatCheckIndex + 1),
          ]
        : [...localRecentSearchWords.value];
    recentWords.length >= 5 ? recentWords.pop() : '';

    localRecentSearchWords.value = [searchWord, ...recentWords];
  }

  // recent words delete
  function recentWordDelete(index) {
    const recentWords = [
      ...localRecentSearchWords.value.slice(0, index),
      ...localRecentSearchWords.value.slice(index + 1),
    ];
    localRecentSearchWords.value = [...recentWords];
  }

  return {
    wordArr,
    localTrashCan,
    localRecentSearchWords,
    screenTransition,
    setWordDic,
    wordAdd,
    wordCheck,
    wordDelete,
    contentChange,
    wordDetail,
    trashCanWordDetail,
    trashCanWordKill,
    trashCanWordRestore,
    recentWordUpdate,
    recentWordDelete,
  };
});
```

현재 mainStore에서는 화면 전환 상태, 로컬 스토리지의 단어, 로컬 스토리지의 쓰레기통 단어, 로컬 스토리지의 최근 검색한 단어를 관리한다. 이 네 개의 상태를 각각 분리하려 한다.




---